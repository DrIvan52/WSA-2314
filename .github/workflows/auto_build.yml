name: Auto Build (test)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ‚ôªÔ∏è
        uses: actions/checkout@v4

      - name: Setup Python üë∑
        uses: actions/setup-python@v4
        with:
          check-latest: true
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: scripts/

      - name: Setup Python3 Virtual Enviroment üêç
        working-directory: scripts
        run: |
          sudo apt-get update
          PYTHON_VENV_DIR="$(dirname "$PWD")/python3-env"
          python3 -m venv "$PYTHON_VENV_DIR" || abort "Failed to create python3 virtual env"
          # shellcheck disable=SC1091
          source "$PYTHON_VENV_DIR/bin/activate" || abort "Failed to activate python3 virtual env"
          python3 -c "import pkg_resources; pkg_resources.require(open('requirements.txt',mode='r'))" &>/dev/null || {
              echo "Installing Python3 dependencies"
              python3 -m pip install --upgrade -r requirements.txt || abort "Failed to install python3 dependencies"
          }
          deactivate

      - name: Install Ubuntu Dependencies üßë‚Äçüè≠
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: e2fsprogs attr unzip qemu-utils python3-venv
          version: 1.0

      - name: Download Files
        id: download
        run: |
          WORK_DIR=$(mktemp -d -t wsa-build-XXXXXXXXXX_) || exit 1
          DOWNLOAD_DIR=../download
          DOWNLOAD_CONF_NAME=download.list
          WSA_WORK_ENV="${WORK_DIR:?}/ENV"
          touch "$WSA_WORK_ENV"
          export WSA_WORK_ENV
          abort() {
            [ "$1" ] && echo -e "ERROR: $1"
            echo "Build: an error has occurred, exit"
            exit 1
          }
          trap abort INT TERM
          pip install -r ./scripts/requirements.txt
          echo "Generate Download Links"
          cd ./scripts
          python3 generateWSALinks.py x64 WIF "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME"
          python3 generateWSALinks.py arm64 WIF "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME" --skip_download_wsa
          python3 generateMagiskLink.py stable "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME"
          python3 generateMagiskLink.py delta "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME"
          python3 generateGappsLink.py x64 "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME" MindTheGapps-x64-13.0.zip
          python3 generateGappsLink.py arm64 "$DOWNLOAD_DIR" "$DOWNLOAD_CONF_NAME" MindTheGapps-arm64-13.0.zip
          echo "Download Artifacts"
          if ! aria2c --no-conf --log-level=info --log="$DOWNLOAD_DIR/aria2_download.log" -x16 -s16 -j5 -c -R -m0 --async-dns=false --check-integrity=true --continue=true --allow-overwrite=true --conditional-get=true -d"$DOWNLOAD_DIR" -i"$DOWNLOAD_DIR/$DOWNLOAD_CONF_NAME"; then
            echo "We have encountered an error while downloading files."
            echo "download=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        id: check_release
        run: |
          existing_release=$(curl -s -H "Authorization: Bearer ${{ secrets.PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.download.outputs.WSAVER }}")
          if [ -z "$existing_release" ]; then
            echo "Release does not exist"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          else
            echo "Release already exists"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Create release ü§å
        if: steps.check_release.outputs.release_exists == 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            ## Hashes
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-1
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch x64 --release-type WIF --gapps-brand MindTheGapps --root-sol magisk --magisk-ver stable --remove-amazon --compress-format zip

      - name: File Checksum ‚úîÔ∏è
        id: hash-1
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-1.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-1.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"

      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.wsa-1.outputs.artifact }}
          path: ${{ github.workspace }}/output/${{ steps.wsa-1.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-1.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-1.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-1.outputs.MD5 }}
            SHA256: ${{ steps.hash-1.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-2
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch x64 --release-type WIF --gapps-brand MindTheGapps --root-sol magisk --magisk-ver delta --remove-amazon --compress-format zip
      
      - name: File Checksum ‚úîÔ∏è
        id: hash-2
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-2.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-2.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"
      
      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
            name: ${{ steps.wsa-2.outputs.artifact }}
            path: ${{ github.workspace }}/output/${{ steps.wsa-2.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-2.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-2.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-2.outputs.MD5 }}
            SHA256: ${{ steps.hash-2.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-3
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch x64 --release-type WIF --gapps-brand none --root-sol magisk --magisk-ver stable --remove-amazon --compress-format zip

      - name: File Checksum ‚úîÔ∏è
        id: hash-3
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-3.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-3.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"

      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.wsa-3.outputs.artifact }}
          path: ${{ github.workspace }}/output/${{ steps.wsa-3.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-3.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-3.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-3.outputs.MD5 }}
            SHA256: ${{ steps.hash-3.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-4
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch x64 --release-type WIF --gapps-brand none --root-sol magisk --magisk-ver delta --compress-format zip
      
      - name: File Checksum ‚úîÔ∏è
        id: hash-4
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-4.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-4.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"
      
      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
            name: ${{ steps.wsa-4.outputs.artifact }}
            path: ${{ github.workspace }}/output/${{ steps.wsa-4.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-4.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-4.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-4.outputs.MD5 }}
            SHA256: ${{ steps.hash-4.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-5
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch arm64 --release-type WIF --gapps-brand MindTheGapps --root-sol magisk --magisk-ver stable --remove-amazon --compress-format zip

      - name: File Checksum ‚úîÔ∏è
        id: hash-5
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-5.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-5.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"

      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.wsa-5.outputs.artifact }}
          path: ${{ github.workspace }}/output/${{ steps.wsa-5.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-5.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-5.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-5.outputs.MD5 }}
            SHA256: ${{ steps.hash-5.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-6
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch arm64 --release-type WIF --gapps-brand MindTheGapps --root-sol magisk --magisk-ver delta --compress-format zip
      
      - name: File Checksum ‚úîÔ∏è
        id: hash-6
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-6.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-6.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"
      
      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
            name: ${{ steps.wsa-6.outputs.artifact }}
            path: ${{ github.workspace }}/output/${{ steps.wsa-6.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-6.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-6.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-6.outputs.MD5 }}
            SHA256: ${{ steps.hash-6.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-7
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch arm64 --release-type WIF --gapps-brand none --root-sol magisk --magisk-ver stable --remove-amazon --compress-format zip

      - name: File Checksum ‚úîÔ∏è
        id: hash-7
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-7.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-7.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"

      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.wsa-7.outputs.artifact }}
          path: ${{ github.workspace }}/output/${{ steps.wsa-7.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-7.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-7.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-7.outputs.MD5 }}
            SHA256: ${{ steps.hash-7.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}

      - name: Build WSA üèóÔ∏è
        if: steps.download.outputs.download != 'false'
        id: wsa-8
        run: |
          ./scripts/build.sh --offline --custom-model redfin --arch arm64 --release-type WIF --gapps-brand none --root-sol magisk --magisk-ver delta --compress-format zip
      
      - name: File Checksum ‚úîÔ∏è
        id: hash-8
        if: steps.download.outputs.download != 'false'
        run: |
          filedir="${{ github.workspace }}/output/${{ steps.wsa-8.outputs.artifact }}"
          md5_hash=$(md5sum "$filedir" | cut -d ' ' -f 1)
          sha256_hash=$(sha256sum "$filedir" | cut -d ' ' -f 1)
          md5_hash_lower=$(echo "$md5_hash" | tr '[:upper:]' '[:lower:]')
          sha256_hash_lower=$(echo "$sha256_hash" | tr '[:upper:]' '[:lower:]')
          echo "MD5=$md5_hash_lower" >> $GITHUB_OUTPUT
          echo "SHA256=$sha256_hash_lower" >> $GITHUB_OUTPUT
          echo "${{ steps.wsa-8.outputs.artifact }}"
          echo "MD5=$md5_hash_lower"
          echo "SHA256=$sha256_hash_lower"
      
      - name: Upload Artifact üì¶
        if: steps.download.outputs.download != 'false'
        uses: actions/upload-artifact@v3
        with:
            name: ${{ steps.wsa-8.outputs.artifact }}
            path: ${{ github.workspace }}/output/${{ steps.wsa-8.outputs.artifact }}

      - name: Update build to release ü§å
        if: steps.download.outputs.download != 'false'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ github.workspace }}/output/${{ steps.wsa-8.outputs.artifact }}
          fail_on_unmatched_files: true
          append_body: true
          tag_name: ${{ steps.download.outputs.WSAVER }}
          body: |
            - ${{ steps.wsa-8.outputs.artifact }}
            ```yaml
            MD5: ${{ steps.hash-8.outputs.MD5 }}
            SHA256: ${{ steps.hash-8.outputs.SHA256 }}
            ```
          token: ${{ secrets.PAT }}
